{% extends "base.html" %}
{% load static %}
{%block title%}
<title>Event details</title>
{% endblock%}

{% block content %}
<section>
    <div 
      class="mx-auto" 
    > <!-- here the overall container -->
    
      <div class="grid gap-6 p-2  min-h-screen lg:grid-cols-2 ">
        <div class="relative overflow-hidden">
            <img
            alt="Party"
            src="{% static 'img/img1.jpeg' %}"
            class="absolute inset-0 w-full  rounded-lg object-cover "
            />
        </div>
        <div class="lg:py-24">
          <h2 class="flex justify-center text-3xl font-bold sm:text-4xl">Grow your audience</h2>
  
          <p class="mt-4 text-gray-600">
            Lorem ipsum dolor, sit amet consectetur adipisicing elit. Aut qui hic
            atque tenetur quis eius quos ea neque sunt, accusantium soluta minus
            veniam tempora deserunt? Molestiae eius quidem quam repellat.
            Lorem ipsum dolor, sit amet consectetur adipisicing elit. Aut qui hic
            atque tenetur quis eius quos ea neque sunt, accusantium soluta minus
            veniam tempora deserunt? Molestiae eius quidem quam repellat.
            Lorem ipsum dolor, sit amet consectetur adipisicing elit. Aut qui hic
            atque tenetur quis eius quos ea neque sunt, accusantium soluta minus
            veniam tempora deserunt? Molestiae eius quidem quam repellat.


          </p>
          <p class="flex justify-center">
          <button data-modal-target="staticModal" data-modal-toggle="staticModal" 
          type="button"
            href="#"
            class="mt-2 mx-auto inline-block rounded-full bg-indigo-600 px-12 py-4 text-sm font-medium text-white transition hover:bg-indigo-700 focus:outline-none focus:ring focus:ring-yellow-400"
          >
              TICKETS
          </button>
        </p>
  
  

        </div>

      </div>
    </div>
  </section>
<!-- <main class="p-6">
    <div class="container mx-auto space-y-16">
        <section class="grid  text-center lg:grid-cols-2 xl:grid-cols-5 bg-black">
            <img class="w-full object-cover object-center" src="{{ event.event_banners.url }}" alt="Event Image" />

            <div class="p-6  sm:p-16 xl:col-span-2 dark:bg-gray-900">
                <h1 class="text-5xl font-extrabold dark:text-gray-50">{{event.name}}</h1>
                <p class="my-8">
                    {{event.event_description}}
                </p>
                <button data-modal-target="staticModal" data-modal-toggle="staticModal" class="h-10 px-6 text-indigo-100 transition-colors duration-150 bg-indigo-500 rounded-full focus:shadow-outline hover:bg-indigo-800" type="button">
                    Tickets
                </button>

            </div>
        </section>

    </div>
</main> -->

  <!-- Main modal -->
  <div id="staticModal" data-modal-backdrop="static" tabindex="-1" aria-hidden="true" class="fixed top-0 left-0 right-0 z-50 hidden w-full p-4 overflow-x-hidden overflow-y-auto md:inset-0 h-[calc(100%-1rem)] max-h-full">
    <div class="relative w-full max-w-2xl max-h-full">
        <!-- Modal content -->
        <div class="relative bg-white rounded-lg shadow dark:bg-gray-700">
            <!-- Modal header -->
            <div class="flex items-start justify-between p-4 border-b rounded-t dark:border-gray-600">
                <h3 class="text-xl font-semibold text-gray-900 dark:text-white">
                    Tickets
                </h3>
                <button type="button" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 ml-auto inline-flex justify-center items-center dark:hover:bg-gray-600 dark:hover:text-white" data-modal-hide="staticModal">
                    <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14">
                        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"/>
                    </svg>
                    <span class="sr-only">Close modal</span>
                </button>
            </div>
            <!-- Modal body -->
            <form id="Ticketform" action="{% url 'checkout' %}" method="POST">
              {% csrf_token %}
                  <div class="p-4 ">
                      <div id="step1" class="step text-base leading-relaxed text-gray-500">
                          <div class="p-6">
                              {% for ticket in event.tickets.all%}
                                <div id="ticket-{{ forloop.counter }}" class="ticket">
                                    <div class="flex items-center justify-between sm:ml-4  sm:w-full sm:justify-between">
                                      <div class="mt-5 sm:mt-0">
                                        <h2 class="text-lg font-bold text-gray-900">{{ticket.name}}</h2>
                                        <p class="ticket_price mt-1 text-xs text-gray-700">{{ticket.price}}</p>
                                      </div>
                                      <div class="mt-4 flex sm:space-y-6 justify-between items-center sm:mt-0 sm:block sm:space-x-6">
                                        <div class="flex items-center justify-between border-gray-100">
                                            <button class="decrease_btn cursor-pointer rounded bg-gray-200 py-1 px-3 duration-100" type="button" disabled> - </button>
                                            <span class="item_count rounded bg-gray-50 w-10 py-1 px-3 flex items-center justify-center duration-100"> 0 </span>
                                            <button class="increase_btn cursor-pointer rounded bg-gray-200 py-1 px-3 duration-100 hover:bg-blue-500 hover:text-blue-50" type="button"> + </button>
                                        </div>
                                    </div>
                                  </div>
                                </div>
                              {% endfor%}
                          </div>
              <!-- order summary -->
              <div class="price-info bg-black">
                  <!-- summary header -->
                  <div class="summary-header grid grid-cols-3 p-2 items-center pl-2 bg-green-950">
                      <p class="p-1">Summary</p>
                      <p>QTY</p> 
                      <p>Amount</p>
                  </div>
                  {% for ticket in event.tickets.all%}
                  <div class="ticket-{{ forloop.counter }} summary-content grid grid-cols-3 p-2 items-center">
                      <span class="m-1">Ticket #{{ forloop.counter }} {{ticket.name}}</span>
                      <span class="ticket-qty p-1">0</span>
                      <span class="ticket-amount p-1">0</span>
                  </div>
                  {% endfor%}
                  <div class="summary-header px-4 text-xl  bg-orange-100">
                    <p> 
                      Ticket quantity:
                      <span id="cart_total_count">0</span>
                    </p>
                    <p> 
                      Total:
                      <span class="">UGX.
                      <span id="cart_total_amount">0</span>
                      </span>
                    </p>
                  </div>


              </div>
                      </div>
                      <div id="step2" class="step hidden text-base leading-relaxed text-gray-500">
                          <div id="info" class="overflow-y-scroll h-96"></div>
                      </div>
                  </div>
                  <!-- Modal footer -->
                  <div class="flex justify-between p-6 space-x-2 border-t border-gray-200">
                        <button id="prev" type="button" onclick="prevStep('step1')" class="hidden text-gray-500 bg hover:bg-gray-100 rounded-lg border border-gray-200 text-sm font-medium px-5 py-2.5 hover:text-gray-900 focus:z-10">Back</button>
                      <button id="next" type="button" onclick="nextStep('step2')" class="hover:bg-gray-100 rounded-lg border border-gray-200 text-sm font-medium px-5 py-2.5 hover:text-gray-900 focus:z-10" disabled>Next</button>
                  </div>
            </form>
        </div>
    </div>
</div>


<!-- MODAL NAVIGATION -->
<script>
  function nextStep(nextStepId) {
    document.getElementById(nextStepId).classList.remove('hidden');
    document.getElementById('step1').classList.add('hidden');
    document.getElementById('prev').classList.remove('hidden');
    document.getElementById('next').innerHTML = 'Next';
    document.getElementById('next').setAttribute('type', 'button');
    document.getElementById('next').innerHTML = 'Continue';
    document.getElementById('next').addEventListener('click', submitForm);
  }

  function prevStep(prevStepId) {
    document.getElementById(prevStepId).classList.remove('hidden');
    document.getElementById('step2').classList.add('hidden');
    document.getElementById('prev').classList.add('hidden');
    document.getElementById('next').innerHTML = 'Next';
    document.getElementById('next').setAttribute('type', 'button');
    document.getElementById('next').innerHTML = 'Next';
    document.getElementById('next').removeEventListener('click', submitForm);
  }

  function submitForm() {
    // check for erquired fields
    document.getElementById('Ticketform').submit();
  }

</script>
<!-- MODAL CALCULATIONS -->
<script>
  const increase_btns = document.querySelectorAll('.increase_btn');
  const decrease_btns = document.querySelectorAll('.decrease_btn');
  const priceInfo = document.querySelector('.price-info');


  increase_btns.forEach((button)=>{
      button.addEventListener('click',()=>{
        var parent =  button.closest('.ticket');
        var price = parent.querySelector('.ticket_price').textContent;
        var itemCount = parent.querySelector('.item_count');
        const parent_id = parent.id;
        var ticketSummary = document.querySelector(`.${parent_id}`);
        
        var count = parseInt(itemCount.textContent);
        count++;
        itemCount.textContent = count;
        var total = count*price;
        ticketSummary.querySelector('.ticket-qty').innerHTML = count;
        ticketSummary.querySelector('.ticket-amount').innerHTML = total;

        if(count !== 0){
          parent.querySelector('.decrease_btn').removeAttribute('disabled','disabled');
          parent.querySelector('.decrease_btn').classList.add('hover:bg-blue-500');
          parent.querySelector('.decrease_btn').classList.add('hover:text-blue-500');
          // toggle next button
          document.getElementById("next").removeAttribute('disabled','disabled');
          document.getElementById("next").classList.add('bg-blue-600');
        }else{
          document.getElementById("next").setAttribute('disabled','disabled');
          document.getElementById("next").classList.remove('bg-blue-600');
        }




        UpdateCartTotal();
        updateTicketTypes();
      });
  });

  decrease_btns.forEach((button)=>{
      button.addEventListener('click',()=>{
        var parent =  button.closest('.ticket');
          var price = parent.querySelector('.ticket_price').textContent;
          var itemCount = parent.querySelector('.item_count');
          const parent_id = parent.id;
          var ticketSummary = document.querySelector(`.${parent_id}`);
        
          var count = parseInt(itemCount.textContent);
          count--;
          itemCount.textContent = count;
          var total = count*price;
          ticketSummary.querySelector('.ticket-qty').innerHTML = count;
          ticketSummary.querySelector('.ticket-amount').innerHTML = total;

          if(count === 0){
            parent.querySelector('.decrease_btn').setAttribute('disabled','disabled');
            parent.querySelector('.decrease_btn').classList.remove('hover:bg-blue-500');
            parent.querySelector('.decrease_btn').classList.remove('hover:text-blue-500');
          // toggle next button
            document.getElementById("next").setAttribute('disabled','disabled');
            document.getElementById("next").classList.remove('bg-blue-600');

          }else{
            parent.querySelector('.decrease_btn').removeAttribute('disabled','disabled');
            //toggle next button
            document.getElementById("next").removeAttribute('disabled','disabled');
            document.getElementById("next").classList.add('bg-blue-600');
          }

          UpdateCartTotal();
          updateTicketTypes();
      });
  });


  // Cart summary
  function UpdateCartTotal(){
      var totalTicketQunatity = 0;
      var totalTicketsAmount = 0;
      const ticketCountElements = document.querySelectorAll('.item_count'); // check on using var or const in future in case of variable ticket count
      const totalAmountElements = document.querySelectorAll('.ticket-amount');
      ticketCountElements.forEach(count=>{
          totalTicketQunatity += parseInt(count.innerHTML)
      });

      totalAmountElements.forEach(count=>{
          totalTicketsAmount += parseInt(count.innerHTML);
      });
      document.querySelector('#cart_total_count').innerHTML = totalTicketQunatity;
      document.querySelector('#cart_total_amount').innerHTML = totalTicketsAmount;

  }

  function updateTicketTypes(){
      var ticketTypes = {};
      var count = document.querySelectorAll('.ticket').length;
      for(let num = 1 ;num<=count;num++){
          ticketTypes[`ticket-${num}`] = parseInt(document.querySelector(`.ticket-${num}`).querySelector('.ticket-qty').innerHTML);
      }
      userInfo(ticketTypes);
      updateLocalStorage(ticketTypes);
  }

  // Customer info
  function userInfo(ticketTypes){
      const infoDiv = document.getElementById('info');
      infoDiv.innerHTML = '';
      
      for(let key in ticketTypes){
          if(ticketTypes[key] !== 0){
              const title = `<div class="ml-4"> ${key} </div>`;
              infoDiv.innerHTML += title;
          }

          for (let i = 0; i < ticketTypes[key]; i++) {
              const divContent = `
                    <div class="grid grid-cols-2 gap-1 mx-4">
                      <input type="text" name="first_name" class="block mb-1 text-sm text-gray-900 border rounded-lg bg-gray-50" required>
                      <input type="text" name="last_name" class="block mb-1 text-sm text-gray-900 border rounded-lg bg-gray-50" required>
                      <input type="text" name="phone" class="block mb-1 text-sm text-gray-900 border rounded-lg bg-gray-50" required>
                      <input type="text" name="email" class="block mb-1 text-sm text-gray-900 border rounded-lg bg-gray-50" required>
                    </div>
              `;
              infoDiv.innerHTML += divContent;
              }
          }
  }

  function updateLocalStorage(order_summary){
    order_summary['ticket_quantity'] = document.querySelector('#cart_total_count').innerHTML;
    order_summary['total_amount'] = document.querySelector('#cart_total_amount').innerHTML;
    localStorage.setItem('order_summary',JSON.stringify(order_summary))
  }

  
</script>

{% endblock %}
